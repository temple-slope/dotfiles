# Codex ガイドライン

Claude が OpenAI Codex CLI を呼び出す際の判断基準・方法・出力処理を定めたルール。

## 1. 発動条件

### 発動する場合

| 条件 | 説明 |
|---|---|
| **実装不確実** | 複数アプローチで迷い、Claude 自身が判断できない |
| **知識範囲外** | 最新ライブラリ・ニッチな技術で Claude の知識に自信がない |
| **セカンドオピニオン** | 自分の判断を別モデルで検証したい |

### 発動しない場合

- 実装方針が明確な場合
- 単純なバグ修正やリファクタリング
- Claude が十分な知識と自信を持っている場合

## 2. 呼び出し前の通知

Codex を呼び出す前に必ずユーザーへ通知する:

```
Codex を呼び出します: [目的の説明] / モード: [suggest|auto-edit]
```

## 3. 呼び出し方法

**必須: 非対話モードのフラグを指定する（フラグなしでの実行は禁止）**

```bash
# 提案のみ・何も変更しない（調査・セカンドオピニオン向け）
codex --approval-mode suggest "<タスク説明>"

# ファイル変更自動承認・コマンド実行は確認（実装補完向け・推奨）
codex --approval-mode auto-edit "<タスク説明>"
```

### 承認モードの使い分け

| モード | 動作 | 用途 |
|---|---|---|
| `suggest` | 提案のみ、変更なし | セカンドオピニオン・コード提案の確認 |
| `auto-edit` | ファイル変更OK・コマンド確認あり | 実装補完（推奨） |
| `full-auto` | 全自動 | 機密・本番環境へのアクセスがない場合のみ |
| フラグなし | **禁止** | TUI の対話プロンプトで詰まるため |

## 4. プロンプト設計

効果的な指示の書き方:

- 対象ファイルパスを含める
- 制約条件（言語、フレームワーク、バージョン）を明示
- 期待する出力（提案だけ？変更も？）を明確化

**例:**
```bash
codex --approval-mode suggest "以下のファイルで Go テンプレート構文のエラーを修正してください: ~/.local/share/chezmoi/dot_zshrc.tmpl。chezmoi の .tmpl 形式で、Go テンプレート構文に従ってください。変更せず提案のみ。"
```

## 5. 出力の扱い

- Codex の変更をそのまま採用しない（コードレビュー必須）
- Claude の判断と相違する場合はユーザーに両案を提示
- セキュリティ懸念がある変更はユーザー確認必須
- chezmoi 管理ファイルに変更が及ぶ場合は `cz-sync` を実行

## 6. 制約・禁止事項

- フラグなしでの実行禁止（TUI 問題を回避するため）
- `full-auto` モードで本番環境・機密データへのアクセスは禁止
- Codex 失敗時は通常フローに戻る（固執しない）
- Codex の出力はあくまで参考情報。Claude が最終判断を行う

## 7. 将来の移行

現時点は CLI ベース。公式 MCP サーバーが提供されたら MCP に移行する。
移行後はこのファイルを更新すること。
